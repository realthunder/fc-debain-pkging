#!/usr/bin/make -f

ifeq ($(findstring parallel=,$(DEB_BUILD_OPTIONS)),)
	export DEB_BUILD_OPTIONS+=parallel=$(shell getconf _NPROCESSORS_ONLN)
endif

%:
	dh $@ --buildsystem=cmake --parallel --with python3

DEB_BUILD_GNU_TYPE  ?= $(shell dpkg-architecture -qDEB_BUILD_GNU_TYPE)
UBUNTU_CODENAME  := $(shell lsb_release -sc)
UBUNTU_RELEASE  := $(shell lsb_release -sr)

extra_flags += \
-DFREECAD_BUILD_DEBIAN=ON \
-DBUILD_FEM_NETGEN=OFF \
-DBUILD_PATH=OFF \
-DBUILD_FEM_VTK=ON \
-DCMAKE_CXX_FLAGS="-Wall -DHAVE_SWIG=1 -fpermissive $(shell dpkg-buildflags --get CXXFLAGS) $(shell dpkg-buildflags --get CPPFLAGS)" \
-DCMAKE_C_FLAGS="-Wall -fpermissive $(shell dpkg-buildflags --get CFLAGS) $(shell dpkg-buildflags --get CPPFLAGS)" \
-DCMAKE_SHARED_LINKER_FLAGS="$(shell dpkg-buildflags --get LDFLAGS)" \
-DLIB_SUFFIX="" \
-DOCC_INCLUDE_DIR="/usr/include/opencascade" \
-DCMAKE_INSTALL_PREFIX="/usr/lib/freecad-testing" \
-DCMAKE_INSTALL_DATADIR="/usr/share/freecad-testing" \
-DCMAKE_INSTALL_DOCDIR="/usr/share/doc/freecad-testing-doc" \
-DPYTHON_BASENAME=.cpython-34m \
-DPYTHON_EXECUTABLE=/usr/bin/python3.4 \
-DPYTHON_INCLUDE_DIR=/usr/include/python3.4m \
-DPYTHON_LIBRARY=/usr/lib/x86_64-linux-gnu/libpython3.4m.so \
-DPYTHON_SUFFIX=.cpython-34m \
-DSWIG_DIR=/usr/share/swig3.0 \
-DSWIG_EXECUTABLE=/usr/bin/swig3.0 \

override_dh_auto_configure:
	dh_auto_configure -- $(extra_flags) -DCMAKE_CXX_COMPILER=/usr/bin/mpic++
	cp -f src/Build/Version.h obj-$(DEB_BUILD_GNU_TYPE)/src/Build/Version.h
	# fix for Ubuntu bug - 1556680
	# https://bugs.launchpad.net/ubuntu/+source/oce/+bug/1556680

override_dh_compress:
	dh_compress -X.qch -X.qhc

override_dh_installchangelogs:
	dh_installchangelogs ChangeLog.txt
	
override_dh_installmime:
	dh_installmime
	dh_install debian/mime/freecad-testing-thumbnailer usr/bin
	dh_install debian/mime/freecad-testing.thumbnailer usr/share/thumbnailers
	dh_install debian/mime/freecad-testing.schemas etc/gconf/schemas

override_dh_icons:
	install -m 644 debian/freecad-testing/usr/share/freecad-testing/freecad-icon-16.png debian/freecad-testing/usr/share/icons/hicolor/16x16/apps/freecad-testing.png
	install -m 644 debian/freecad-testing/usr/share/freecad-testing/freecad-icon-32.png debian/freecad-testing/usr/share/icons/hicolor/32x32/apps/freecad-testing.png
	install -m 644 debian/freecad-testing/usr/share/freecad-testing/freecad-icon-32.png debian/freecad-testing/usr/share/icons/hicolor/48x48/apps/freecad-testing.png
	install -m 644 debian/freecad-testing/usr/share/freecad-testing/freecad-icon-64.png debian/freecad-testing/usr/share/icons/hicolor/64x64/apps/freecad-testing.png
	install -m 644 debian/freecad-testing/usr/share/freecad-testing/freecad.svg debian/freecad-testing/usr/share/icons/hicolor/scalable/apps/freecad-testing.svg

